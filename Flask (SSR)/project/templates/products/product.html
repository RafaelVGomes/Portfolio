{% extends "layout.html" %}

{% block title %}
    Product
{% endblock title %}

{% block main %}
    <script type="text/javascript">
        $(document).ready(function() {
            $('#itemsContainer').hide()
            if ($('#productData').html()) {
                const data = JSON.parse($('#productData').html())
                Object.entries(data).forEach(([key, value]) => {
                    $(`#${key}`).val(value)
                    if (key == "has_recipe" && value == 0) {
                        $('#hasRecipe0').attr('checked', 'checked')
                    } else if (key == "has_recipe" && value == 1) {
                        $('#hasRecipe1').attr('checked', 'checked')
                        $('#itemsContainer').show()
                    }
                })
            }

            $('[name="has_recipe"]').change(function() {
                if ($(this).val() == 1) {
                    $('#itemsContainer').show()

                    $("#itemsColumn").find("input[type=checkbox]:checked").each(function() {
                        $(this).prop('checked', false)
                    })
                } else {
                    $('#itemsContainer').hide()

                    let deletedForms = []

                    $("#itemsColumn").find("input[type=checkbox]").each(function() {
                        $(this).prop('checked', true)
                    })

                    $("#inlineFormsTotal").val($("#itemsColumn").children().length)

                    $("#itemsColumn").find("input[type=checkbox]:checked").each(function() {
                        const form = $($(this).val())
                        const index = Number(form.attr('id').match(/(\d$)/g)[0])
                        deletedForms.push(index)
                    })

                    $("#deletedInlineForms").val(deletedForms)
                }
            })

            $('#delItemBtn').attr('disabled', 'disabled')

            let checked = 0
            $('input[type=checkbox]').click(function() {
                let formsAmount = $("#itemsColumn").children().length
                if (this.checked) {
                    checked++
                } else {
                    checked--
                }

                if (checked == formsAmount || formsAmount < 2) {
                    $('#delItemBtn').attr('disabled', 'disabled')
                } else {
                    $('#delItemBtn').removeAttr('disabled')
                }
            })

            let createdForms = []
            if (!$('#recipesData').html()) {
                createdForms.push(0)
                $("#createdInlineForms").val(createdForms)
            }

            $("#inlineFormsTotal").val($("#itemsColumn").children().length)
            $('#addItemBtn').click(function() {
                const index = Number($("#inlineFormsTotal").val())
                const form = $(`#inlineForm${index - 1}`).clone(true)
                const formId = form.attr('id').replace(index - 1, index)
                const delForm = form.find(`#delForm${index - 1}`)
                const delFormId = delForm.attr('id').replace(index - 1, index)
                const delFormVal = delForm.attr('value').replace(index - 1, index)
                const select = form.find("select")
                const amount = form.find(`#itemAmount${index - 1}`)
                const amountId = amount.attr('id').replace(index - 1, index)
                const name = select.attr("name").replace(index - 1, index)

                form.attr('id', formId)
                delForm.attr('id', delFormId)
                delForm.prop('checked', false)
                delForm.val(delFormVal)
                select.attr('name', name)
                select.children().each(function() {
                    $(this).prop('selected', false)
                })
                select.children().first().prop('selected', true)
                amount.attr('name', name)
                amount.val(null)
                amount.attr('id', amountId)

                $("#itemsColumn").append(form)
                $("#inlineFormsTotal").val(index + 1)

                if ($("#itemsColumn").children().length > 1) {
                    $('#delItemBtn').removeAttr('disabled')
                }

                createdForms.push(index)
                $("#createdInlineForms").val(createdForms)
            })

            let deletedForms = []
            $("#delItemBtn").click(function() {
                $("#itemsColumn").find("input[type=checkbox]:checked").each(function() {
                    const form = $($(this).val())
                    const index = Number(form.attr('id').match(/(\d$)/g)[0])
                    deletedForms.push(index)
                    form.hide()
                    $("#inlineFormsTotal").val($("#inlineFormsTotal").val() - 1)
                    checked--
                })

                $("#deletedInlineForms").val(deletedForms)

                let formsAmount = $("#itemsColumn").children().length
                if (checked == formsAmount || formsAmount < 2) {
                    $('#delItemBtn').attr('disabled', 'disabled')
                } else {
                    $('#delItemBtn').removeAttr('disabled')
                }
            })
        })
    </script>

    {% if product %}
        <div id="productData" hidden>
            {{ product|tojson}}
        </div>
    {% endif %}

    {% if recipes %}
        <div id="recipesData" hidden>
            {{ recipes|tojson }}
        </div>
    {% endif %}

    <form action="/{% if product %}upd-product/{{product['id']}}{% else %}add-product{% endif %}" method="post">
        <div class="mb-3">
            <input autocomplete="off" autofocus class="form-control mx-auto w-auto" id="product_name" name="product_name" placeholder="Product name" type="text" {% if product %} disabled {% endif %}>
        </div>
        <div class="mb-3">
            <input autocomplete="off" class="form-control mx-auto w-auto" id="amount" name="amount" placeholder="Amount" type="number" step="0.1" min="0">
        </div>
        <div class="mb-3">
            <select class="form-select mx-auto w-auto" name="measure" id="measure" aria-label="Unit of measurement">
                <option value="" selected>Unit of measurement</option>
                <option value="Kg">Kg</option>
                <option value="L">L</option>
                <option value="Unit">Unit</option>
            </select>
        </div>
        <div class="mb-3">
            <input autocomplete="off" class="form-control mx-auto w-auto" id="quantity_alert" name="quantity_alert" placeholder="Quantity alert" type="number" step="0.1" min="0">
        </div>
        <div class="mb-3">
            <input autocomplete="off" class="form-control mx-auto w-auto" id="price" name="price" placeholder="Price" type="number" step="0.01" min="0">
        </div>
        <p>Does this product have a recipe?</p>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="has_recipe" id="hasRecipe0" value="0" checked>
            <label class="form-check-label" for="exampleRadios1">
                No
            </label>
        </div>
        <div class="form-check form-check-inline mb-3">
            <input class="form-check-input" type="radio" name="has_recipe" id="hasRecipe1" value="1">
            <label class="form-check-label" for="exampleRadios2">
                Yes
            </label>
        </div>
        <div class="container mb-3" id="itemsContainer">
            <div class="row align-items-center justify-content-center">
                <div class="col-3" id="itemsColumn">
                    {% if not recipes %}
                        <div class="row" id="inlineForm0">
                            {% if items %}
                                <div class="col-1">
                                    <input class="form-check-input" type="checkbox" id="delForm0" value="#inlineForm0">
                                </div>
                                <div class="col">
                                    <div class="input-group mb-3">
                                        <select class="form-select" name="recipe_items_0" aria-label="Items to add">
                                            <option selected>Select an item</option>
                                            {% for item in items %}
                                                <option value="{{ item['id']}}, {{ item['item_name'] }}">{{ item['item_name']|title }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-5">
                                    <input autocomplete="off" class="form-control" id="itemAmount0" name="recipe_items_0" placeholder="Qnt" type="number" step="0.01" min="0">
                                </div>
                            {% else %}
                                <select class="form-select" aria-label="Items to add" disabled>
                                    <option selected>There's no items on stock</option>
                                </select>
                            {% endif %}
                        </div>
                    {% else %}
                        {% for recipe in recipes %}
                            <div class="row" id="inlineForm{{ loop.index0 }}">
                                {% if items %}
                                    <div class="col-1">
                                        <input class="form-check-input" type="checkbox" id="delForm{{ loop.index0 }}" value="#inlineForm{{ loop.index0 }}">
                                    </div>
                                    <div class="col">
                                        <div class="input-group mb-3">
                                            <select class="form-select" name="recipe_items_{{ loop.index0 }}" aria-label="Items to add">
                                                <option selected>Select an item</option>
                                                {% for item in items %}
                                                    <option value="{{ item['id']}}, {{ item['item_name'] }}"
                                                        {% if item['id'] == recipe['item_id'] %}
                                                            selected
                                                        {% endif %}
                                                    >{{ item['item_name']|title }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <input autocomplete="off" class="form-control" id="itemAmount{{ loop.index0 }}" name="recipe_items_{{ loop.index0 }}" placeholder="Qnt" type="number" step="0.01" min="0" value="{{ recipe['amount'] }}">
                                    </div>
                                </div>
                            {% else %}
                                <select class="form-select" aria-label="Items to add" disabled>
                                    <option selected>There's no items on stock</option>
                                </select>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                <input type="hidden" name="inlineFormsTotal" id="inlineFormsTotal" value="1">
                <input type="hidden" name="createdInlineForms" id="createdInlineForms" value="">
                <input type="hidden" name="deletedInlineForms" id="deletedInlineForms" value="">
                <div class="col-1">
                    <button class="btn btn-success mb-1" id="addItemBtn" type="button"><i class="bi bi-plus-lg"></i></button>
                    <button class="btn btn-danger" id="delItemBtn" type="button"><i class="bi bi-trash"></i></button>
                </div>
            </div>
        </div>
        <div>
            <button class="btn btn-primary" type="submit">
                {% if product %}
                    Update
                {% else %}
                    Add
                {% endif %}
            </button>
            <a href="/products" role="button" class="btn btn-danger">Cancel</a>
        </div>
    </form>
{% endblock main %}
